#!/usr/bin/env node
var program = require('commander');
var chalk = require('chalk');
var fs = require('fs');

var packageJson = require('../package.json');
var app = require('../index');

var inputFile;
var outputFile;

program
  .version(packageJson.version)
  .arguments('<input> [output]')
  .action(function onAction(input, output) {
    inputFile = input;
    outputFile = output;
  });

program.on('--help', function() {
  console.log('  Examples:');
  console.log('');
  console.log('    $ musicjson2abc input.json output.abc');
  console.log('    $ musicjson2abc example.json example.abc');
  console.log('');
  console.log('  Hint:');
  console.log('');
  console.log('    The input file should be a valid musicJSON file');
  console.log('    The output file will become a valid abc file.')
  console.log('    This may overwrite existing files.');
  console.log('');
});

program.parse(process.argv);

if (typeof inputFile === 'undefined') {
  console.error(chalk.bold.red('ERROR: No input file specified.'));
  console.info(chalk.cyan('Run musicjson2abc -h for further information.'));
  process.exit(1);
}
if (typeof outputFile === 'undefined') {
  outputFile = inputFile.replace(/\.[^/.]+$/, "")
    + ".abc";
  console.info(chalk.cyan('INFO: No output file specified.'));
  console.info(chalk.cyan('Defaults to', outputFile));
}

readInput(inputFile);

/**
 * Reads the JSON eoncoded data from the specified input file
 * @param {string} file - The path to the specified input file
 */
function readInput(file) {
  fs.readFile(file, 'utf8', function(err, data) {
    if (err) {
      console.error(chalk.bold.red('ERROR:', err));
      process.exit(1);
    }
    convert(JSON.parse(data));
  });
}

/**
 * Writes the abc notated string to the specified output file
 * @param {string} file - The path to the specified output file
 * @param {string} data - The data that should be written to the file
 */
function writeOutput(file, data) {
  fs.writeFile(file, data, function(err) {
    if(err) {
      console.error(chalk.bold.red('ERROR:', err));
      process.exit(1);
    }

    console.info(chalk.cyan('Output written to', outputFile));
  });
}

/**
 * Converts input from JSON to abc notation and saves to output file
 * @param {input} input - The parsed input from input file
 */
function convert(input) {
  console.log(input);

  var output = app.convert2Abc(JSON.stringify(input));
  console.log(output);

  writeOutput(outputFile, output);
}

// Run with: musicjson2abc example.json

// Run jsdoc with: jsdoc index.js -d doc -R README.md
